// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER MANAGEMENT & AUTHENTICATION
// ============================================================================

model User {
  id       String  @id @default(uuid())
  email    String  @unique
  password String? // Nullable for social logins
  name     String
  phone    String?
  avatar   String?

  // Social login providers
  googleId   String? @unique
  facebookId String? @unique

  // Account status
  isActive        Boolean   @default(true)
  isVerified      Boolean   @default(false)
  emailVerifiedAt DateTime?
  lastLoginAt     DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Role-based access control
  role UserRole @default(CUSTOMER)

  // Language preference
  preferredLanguage String @default("en") // 'en' or 'ar'


  // 2FA fields
  twoFactorSecret   String?
  twoFactorEnabled  Boolean @default(false)
  backupCodes       String[]
  
  // Relationships
  addresses             Address[]
  orders                Order[]
  favorites             Favorite[]
  cartItems             CartItem[]
  deviceLogs            DeviceLog[]
  conversations         Conversation[] @relation("ConversationUser")
  assignedConversations Conversation[] @relation("ConversationAssignedTo")
  auditLogs             AuditLog[]     @relation("AuditUser")
  adminLogs             AuditLog[]     @relation("AuditAdmin")
  Message               Message[]
  websocketConnections  WebSocketConnection[]
  customers             Customer[]
  passwordResetTokens   PasswordResetToken[]

  @@map("users")
}

enum UserRole {
  CUSTOMER
  SUPPORT
  CONTENT
  MANAGER
  ADMIN
  OWNER
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  
  // Relationships
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("password_reset_tokens")
}

model Address {
  id             String  @id @default(uuid())
  userId         String
  name           String // Address name/label
  recipientName  String // Person receiving the order
  phone          String
  secondaryPhone String?

  // Egyptian address hierarchy
  country     String  @default("Egypt")
  governorate String // محافظة
  center      String // مركز
  village     String? // قرية/كفر/عزبة/شيخ

  // Detailed address
  street     String
  building   String?
  floor      String?
  apartment  String?
  landmark   String?
  postalCode String?

  // Delivery instructions
  instructions String?

  // Address metadata
  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders    Order[]
  customers Customer[]

  @@map("addresses")
}

// ============================================================================
// PRODUCT CATALOG
// ============================================================================

model Brand {
  id          String  @id @default(uuid())
  name        Json // { ar: "سوليفا", en: "Soleva" }
  description Json?
  logo        String?
  isActive    Boolean @default(true)
  sortOrder   Int     @default(0)

  // SEO
  slug            String @unique
  metaTitle       Json?
  metaDescription Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  products Product[]

  @@map("brands")
}

model Category {
  id          String  @id @default(uuid())
  name        Json // { ar: "أحذية رجالي", en: "Men's Shoes" }
  description Json?
  image       String?

  // Hierarchy
  parentId String?
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")

  // Status & ordering
  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  // SEO
  slug            String @unique
  metaTitle       Json?
  metaDescription Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  products Product[]
  storeCategories StoreCategory[]

  @@map("categories")
}

model Collection {
  id          String  @id @default(uuid())
  name        Json // { ar: "كوليكشن الخريف", en: "Fall Collection" }
  description Json?
  image       String?

  // Collection settings
  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)
  sortOrder  Int     @default(0)

  // Schedule
  startDate DateTime?
  endDate   DateTime?

  // SEO
  slug            String @unique
  metaTitle       Json?
  metaDescription Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  products Product[]

  @@map("collections")
}

model Product {
  id          String @id @default(uuid())
  name        Json // { ar: "حذاء سوليفا كلاسيك", en: "Soleva Classic Shoe" }
  description Json

  // Basic info
  sku     String  @unique
  barcode String?

  // Pricing
  basePrice Decimal  @db.Decimal(10, 2)
  salePrice Decimal? @db.Decimal(10, 2)
  costPrice Decimal? @db.Decimal(10, 2)

  // Product attributes
  weight     Decimal? @db.Decimal(8, 2)
  dimensions Json? // { length, width, height }

  // Images and media
  images Json // Array of image URLs
  video  String?

  // Product status
  status     ProductStatus @default(DRAFT)
  isActive   Boolean       @default(true)
  isFeatured Boolean       @default(false)

  // Inventory
  trackInventory    Boolean @default(true)
  stockQuantity     Int     @default(0)
  lowStockThreshold Int     @default(5)

  // SEO
  slug            String @unique
  metaTitle       Json?
  metaDescription Json?
  metaKeywords    Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Foreign keys
  brandId      String?
  categoryId   String?
  collectionId String?

  // Relationships
  brand      Brand?      @relation(fields: [brandId], references: [id])
  category   Category?   @relation(fields: [categoryId], references: [id])
  collection Collection? @relation(fields: [collectionId], references: [id])

  variants           ProductVariant[]
  specifications     ProductSpecification[]
  orderItems         OrderItem[]
  cartItems          CartItem[]
  favorites          Favorite[]
  inventoryMovements InventoryMovement[]
  PurchaseOrderItem  PurchaseOrderItem[]
  flashSaleProducts  FlashSaleProduct[]
  exclusiveOfferProducts ExclusiveOfferProduct[]
  wishlistItems      WishlistItem[]
  storeProducts      StoreProduct[]
  storeInventory     StoreInventory[]

  @@map("products")
}

enum ProductStatus {
  DRAFT
  ACTIVE
  INACTIVE
  OUT_OF_STOCK
  DISCONTINUED
}

model ProductVariant {
  id        String @id @default(uuid())
  productId String

  // Variant attributes
  color    Json // { ar: "أحمر", en: "Red", code: "#DC143C" }
  size     String // "40", "41", "42", etc.
  material String?

  // Variant-specific data
  sku           String  @unique
  barcode       String?
  priceDelta    Decimal @default(0) @db.Decimal(10, 2) // Price difference from base
  stockQuantity Int     @default(0)

  // Images specific to this variant
  images Json? // Array of variant-specific images

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  product            Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems         OrderItem[]
  cartItems          CartItem[]
  inventoryMovements InventoryMovement[]
  PurchaseOrderItem  PurchaseOrderItem[]
  wishlistItems      WishlistItem[]
  storeInventory     StoreInventory[]

  @@unique([productId, color, size])
  @@map("product_variants")
}

model ProductSpecification {
  id        String @id @default(uuid())
  productId String

  key   Json // { ar: "الخامة", en: "Material" }
  value Json // { ar: "جلد طبيعي", en: "Genuine Leather" }

  sortOrder Int @default(0)

  // Relationships
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_specifications")
}

// ============================================================================
// SHOPPING CART & FAVORITES
// ============================================================================

model CartItem {
  id        String  @id @default(uuid())
  userId    String
  productId String
  variantId String?
  quantity  Int     @default(1)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@unique([userId, productId, variantId])
  @@map("cart_items")
}

model Favorite {
  id        String @id @default(uuid())
  userId    String
  productId String

  // Timestamps
  createdAt DateTime @default(now())

  // Relationships
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  customers Customer[]

  @@unique([userId, productId])
  @@map("favorites")
}

// ============================================================================
// ORDER MANAGEMENT
// ============================================================================

model Order {
  id          String @id @default(uuid())
  orderNumber String @unique // Auto-generated order number

  // Customer info
  userId    String
  addressId String
  storeId   String?

  // Order totals
  subtotal       Decimal @db.Decimal(10, 2)
  discountAmount Decimal @default(0) @db.Decimal(10, 2)
  shippingCost   Decimal @default(0) @db.Decimal(10, 2)
  taxAmount      Decimal @default(0) @db.Decimal(10, 2)
  totalAmount    Decimal @db.Decimal(10, 2)

  // Payment info
  paymentMethod   PaymentMethod
  paymentStatus   PaymentStatus @default(PENDING)
  paymentProofUrl String? // For wallet transfers
  senderNumber    String? // For digital wallet transfers

  // Order status
  orderStatus OrderStatus @default(PENDING)

  // Shipping info
  shippingStatus    ShippingStatus @default(PENDING)
  trackingNumber    String?
  estimatedDelivery DateTime?
  actualDelivery    DateTime?

  // Coupon/discount info
  couponCode   String?
  discountType String? // "percentage" or "fixed"

  // Notes
  customerNotes String?
  adminNotes    String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  user     User            @relation(fields: [userId], references: [id])
  address  Address         @relation(fields: [addressId], references: [id])
  items    OrderItem[]
  timeline OrderTimeline[]
  loyaltyTransactions LoyaltyTransaction[]
  store    Store?          @relation(fields: [storeId], references: [id])
  customer Customer?       @relation(fields: [customerId], references: [id])
  customerId String?
  // Relations for promotions
  coupon            Coupon? @relation(fields: [couponId], references: [id])
  couponId          String?
  flashSale         FlashSale? @relation(fields: [flashSaleId], references: [id])
  flashSaleId       String?
  exclusiveOffer    ExclusiveOffer? @relation(fields: [exclusiveOfferId], references: [id])
  exclusiveOfferId  String?

  @@map("orders")
}

enum PaymentMethod {
  CASH_ON_DELIVERY
  BANK_WALLET
  DIGITAL_WALLET
}

enum PaymentStatus {
  PENDING
  AWAITING_PROOF
  UNDER_REVIEW
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
  REFUNDED
}

enum ShippingStatus {
  PENDING
  PROCESSING
  SHIPPED
  OUT_FOR_DELIVERY
  DELIVERED
  FAILED_DELIVERY
  RETURNED
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  productId String
  variantId String?

  quantity   Int
  unitPrice  Decimal @db.Decimal(10, 2)
  totalPrice Decimal @db.Decimal(10, 2)

  // Product snapshot at time of order
  productSnapshot Json // Store product details at time of purchase

  // Timestamps
  createdAt DateTime @default(now())

  // Relationships
  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@map("order_items")
}

model OrderTimeline {
  id      String @id @default(uuid())
  orderId String

  status      String // Status name
  description Json // { ar: "تم تأكيد الطلب", en: "Order confirmed" }
  timestamp   DateTime @default(now())

  // Optional metadata
  metadata Json?

  // Relationships
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_timeline")
}

// ============================================================================
// SHIPPING SYSTEM (EGYPT)
// ============================================================================

model Governorate {
  id       String  @id @default(uuid())
  name     Json // { ar: "القاهرة", en: "Cairo" }
  code     String  @unique
  isActive Boolean @default(true)

  // Default shipping cost for this governorate
  shippingCost Decimal @db.Decimal(8, 2)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  centers       Centers[]
  shippingRates ShippingRate[]

  @@map("governorates")
}

model Centers {
  id            String  @id @default(uuid())
  governorateId String
  name          Json // { ar: "مركز القاهرة", en: "Cairo Center" }
  code          String  @unique
  isActive      Boolean @default(true)

  // Override shipping cost if different from governorate
  shippingCost Decimal? @db.Decimal(8, 2)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  governorate   Governorate    @relation(fields: [governorateId], references: [id], onDelete: Cascade)
  villages      Village[]
  shippingRates ShippingRate[]

  @@map("centers")
}

model Village {
  id       String      @id @default(uuid())
  centerId String
  name     Json // { ar: "كفر الشيخ", en: "Kafr El Sheikh" }
  code     String      @unique
  type     VillageType @default(VILLAGE) // كفر، عزبة، شيخ، قرية
  isActive Boolean     @default(true)

  // Override shipping cost if different from center/governorate
  shippingCost Decimal? @db.Decimal(8, 2)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  center        Centers        @relation(fields: [centerId], references: [id], onDelete: Cascade)
  shippingRates ShippingRate[]

  @@map("villages")
}

enum VillageType {
  KAFR // كفر
  EZBA // عزبة
  SHEIKH // شيخ
  VILLAGE // قرية
}

model ShippingRate {
  id String @id @default(uuid())

  // Location hierarchy - at least one must be specified
  governorateId String?
  centerId      String?
  villageId     String?

  // Shipping cost and rules
  cost          Decimal  @db.Decimal(8, 2)
  freeThreshold Decimal? @db.Decimal(10, 2) // Free shipping above this amount

  // Effective dates
  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  governorate Governorate? @relation(fields: [governorateId], references: [id])
  center      Centers?     @relation(fields: [centerId], references: [id])
  village     Village?     @relation(fields: [villageId], references: [id])

  @@map("shipping_rates")
}

// ============================================================================
// INVENTORY MANAGEMENT
// ============================================================================

model Supplier {
  id      String  @id @default(uuid())
  name    String
  email   String?
  phone   String?
  address String?

  // Contact person
  contactName  String?
  contactEmail String?
  contactPhone String?

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  purchaseOrders PurchaseOrder[]

  @@map("suppliers")
}

model PurchaseOrder {
  id         String @id @default(uuid())
  supplierId String

  orderNumber String              @unique
  status      PurchaseOrderStatus @default(DRAFT)

  // Totals
  subtotal    Decimal @db.Decimal(10, 2)
  taxAmount   Decimal @default(0) @db.Decimal(10, 2)
  totalAmount Decimal @db.Decimal(10, 2)

  // Dates
  orderDate    DateTime  @default(now())
  expectedDate DateTime?
  receivedDate DateTime?

  // Notes
  notes String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  supplier Supplier            @relation(fields: [supplierId], references: [id])
  items    PurchaseOrderItem[]

  @@map("purchase_orders")
}

enum PurchaseOrderStatus {
  DRAFT
  SENT
  CONFIRMED
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

model PurchaseOrderItem {
  id              String  @id @default(uuid())
  purchaseOrderId String
  productId       String
  variantId       String?

  quantity    Int
  unitCost    Decimal @db.Decimal(10, 2)
  totalCost   Decimal @db.Decimal(10, 2)
  receivedQty Int     @default(0)

  // Timestamps
  createdAt DateTime @default(now())

  // Relationships
  purchaseOrder PurchaseOrder   @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product       Product         @relation(fields: [productId], references: [id])
  variant       ProductVariant? @relation(fields: [variantId], references: [id])

  @@map("purchase_order_items")
}

model InventoryMovement {
  id        String  @id @default(uuid())
  productId String
  variantId String?

  type      MovementType
  quantity  Int // Positive for inbound, negative for outbound
  reference String? // Order ID, PO ID, etc.
  reason    String? // Reason for adjustment

  // Timestamps
  createdAt DateTime @default(now())

  // Relationships
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@map("inventory_movements")
}

enum MovementType {
  SALE
  RETURN
  PURCHASE
  ADJUSTMENT
  DAMAGE
  TRANSFER
}

// ============================================================================
// CONTENT MANAGEMENT SYSTEM
// ============================================================================

model CmsBlock {
  id          String @id @default(uuid())
  key         String @unique // "hero_section", "about_us", etc.
  name        Json // { ar: "قسم البطل", en: "Hero Section" }
  description Json?

  // Content
  content Json // Flexible JSON content structure

  // Settings
  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  // Schedule
  startDate DateTime?
  endDate   DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("cms_blocks")
}

model Page {
  id      String @id @default(uuid())
  title   Json // { ar: "من نحن", en: "About Us" }
  content Json // Rich content structure

  // SEO
  slug            String @unique
  metaTitle       Json?
  metaDescription Json?
  metaKeywords    Json?

  // Settings
  isActive    Boolean @default(true)
  isPublished Boolean @default(false)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  @@map("pages")
}

// ============================================================================
// COMMUNICATION & CHAT SYSTEM
// ============================================================================

model Conversation {
  id     String  @id @default(uuid())
  userId String?

  // Conversation metadata
  subject  String?
  source   ConversationSource   @default(WEBSITE)
  status   ConversationStatus   @default(OPEN)
  priority ConversationPriority @default(NORMAL)

  // Assignment
  assignedToId String?

  // Customer info (for anonymous users)
  customerName  String?
  customerEmail String?
  customerPhone String?

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  closedAt  DateTime?

  // Relationships
  user       User?     @relation("ConversationUser", fields: [userId], references: [id])
  assignedTo User?     @relation("ConversationAssignedTo", fields: [assignedToId], references: [id])
  messages   Message[]
  chatbot    ChatBot?  @relation(fields: [chatbotId], references: [id])
  chatbotId  String?

  @@map("conversations")
}

enum ConversationSource {
  WEBSITE
  EMAIL
  PHONE
  WHATSAPP
  FACEBOOK
  INSTAGRAM
}

enum ConversationStatus {
  OPEN
  PENDING
  RESOLVED
  CLOSED
}

enum ConversationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model Message {
  id             String @id @default(uuid())
  conversationId String

  // Message content
  content     String
  type        MessageType @default(TEXT)
  attachments Json? // Array of attachment URLs

  // Sender info
  senderId   String?
  senderType SenderType
  senderName String? // For system messages or AI

  // AI/Bot info
  isFromAI   Boolean @default(false)
  aiModel    String? // "gpt-4", "claude", etc.
  confidence Float? // AI confidence score

  // Message metadata
  metadata Json? // Additional context, order info, etc.

  // Timestamps
  createdAt DateTime  @default(now())
  readAt    DateTime?

  // Relationships
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User?        @relation(fields: [senderId], references: [id])

  @@map("messages")
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  ORDER_INFO
  PRODUCT_LINK
  SYSTEM
}

enum SenderType {
  CUSTOMER
  AGENT
  SYSTEM
  AI
}

// ============================================================================
// DEVICE TRACKING & ANALYTICS
// ============================================================================

model DeviceLog {
  id     String  @id @default(uuid())
  userId String?

  // Device information
  userAgent        String
  deviceType       String // "mobile", "tablet", "desktop"
  os               String
  browser          String
  screenWidth      Int?
  screenHeight     Int?
  devicePixelRatio Float?

  // Performance metrics
  cpuCores       Int?
  memoryGB       Float?
  connectionType String? // "4g", "wifi", etc.

  // Location (IP-based)
  ipAddress String
  country   String?
  city      String?

  // Performance signals
  pageLoadTime Float?
  fcp          Float? // First Contentful Paint
  lcp          Float? // Largest Contentful Paint
  inp          Float? // Interaction to Next Paint
  cls          Float? // Cumulative Layout Shift

  // Adaptive mode
  adaptiveModeEnabled Boolean           @default(false)
  performanceLevel    PerformanceLevel?

  // Timestamps
  createdAt DateTime @default(now())

  // Relationships
  user User? @relation(fields: [userId], references: [id])

  @@map("device_logs")
}

enum PerformanceLevel {
  LOW
  MEDIUM
  HIGH
}

// ============================================================================
// AUDIT & LOGGING
// ============================================================================

model AuditLog {
  id      String  @id @default(uuid())
  userId  String?
  adminId String?

  // Action details
  action     String // "CREATE", "UPDATE", "DELETE"
  resource   String // "Product", "Order", "User"
  resourceId String?

  // Change tracking
  oldValues Json?
  newValues Json?
  changes   Json?

  // Request context
  ipAddress String?
  userAgent String?
  endpoint  String?
  method    String?

  // Timestamps
  createdAt DateTime @default(now())

  // Relationships
  user  User? @relation("AuditUser", fields: [userId], references: [id])
  admin User? @relation("AuditAdmin", fields: [adminId], references: [id])

  @@map("audit_logs")
}

// ============================================================================
// COUPONS & PROMOTIONS
// ============================================================================

model Coupon {
  id          String @id @default(uuid())
  code        String @unique
  name        Json // { ar: "خصم 10%", en: "10% Off" }
  description Json?

  // Discount settings
  type          CouponType
  value         Decimal    @db.Decimal(10, 2) // Percentage or fixed amount
  maxDiscount   Decimal?   @db.Decimal(10, 2) // Max discount for percentage coupons
  minOrderValue Decimal?   @db.Decimal(10, 2) // Minimum order value

  // Usage limits
  usageLimit Int? // Total usage limit
  usageCount Int  @default(0)
  userLimit  Int  @default(1) // Per-user usage limit

  // Validity
  validFrom DateTime
  validTo   DateTime?

  // Additional benefits
  freeShipping Boolean @default(false)

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  orders Order[]

  @@map("coupons")
}

enum CouponType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
}

// ============================================================================
// FLASH SALES & EXCLUSIVE OFFERS
// ============================================================================

model FlashSale {
  id          String @id @default(uuid())
  name        Json // { ar: "عرض فلاش", en: "Flash Sale" }
  description Json?

  // Sale settings
  discountType FlashSaleDiscountType
  discountValue Decimal @db.Decimal(10, 2) // Percentage or fixed amount
  maxDiscount   Decimal? @db.Decimal(10, 2) // Max discount for percentage sales
  minOrderValue Decimal? @db.Decimal(10, 2) // Minimum order value

  // Timing
  startDate DateTime
  endDate   DateTime

  // Status
  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)

  // Display settings
  bannerImage String?
  countdownEnabled Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  products FlashSaleProduct[]
  orders   Order[]

  @@map("flash_sales")
}

enum FlashSaleDiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

model FlashSaleProduct {
  id         String @id @default(uuid())
  flashSaleId String
  productId   String

  // Product-specific settings
  discountValue Decimal? @db.Decimal(10, 2) // Override flash sale discount
  maxQuantity   Int? // Limit quantity per customer
  stockLimit    Int? // Limit total stock for this sale

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())

  // Relationships
  flashSale FlashSale @relation(fields: [flashSaleId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([flashSaleId, productId])
  @@map("flash_sale_products")
}

model ExclusiveOffer {
  id          String @id @default(uuid())
  name        Json // { ar: "عرض حصري", en: "Exclusive Offer" }
  description Json?

  // Offer settings
  discountType ExclusiveOfferDiscountType
  discountValue Decimal @db.Decimal(10, 2)
  maxDiscount   Decimal? @db.Decimal(10, 2)
  minOrderValue Decimal? @db.Decimal(10, 2)

  // Customer segmentation
  customerSegments Json // Array of segment IDs or criteria
  customerIds      String[] // Specific customer IDs

  // Timing
  startDate DateTime
  endDate   DateTime?

  // Status
  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)

  // Display settings
  bannerImage String?
  priority    Int @default(0) // Higher number = higher priority

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  products ExclusiveOfferProduct[]
  orders   Order[]

  @@map("exclusive_offers")
}

enum ExclusiveOfferDiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
  BUY_X_GET_Y
}

model ExclusiveOfferProduct {
  id              String @id @default(uuid())
  exclusiveOfferId String
  productId        String

  // Product-specific settings
  discountValue Decimal? @db.Decimal(10, 2)
  maxQuantity   Int?
  stockLimit    Int?

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())

  // Relationships
  exclusiveOffer ExclusiveOffer @relation(fields: [exclusiveOfferId], references: [id], onDelete: Cascade)
  product        Product        @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([exclusiveOfferId, productId])
  @@map("exclusive_offer_products")
}

// ============================================================================
// CUSTOMER SEGMENTATION & LOYALTY
// ============================================================================

model CustomerSegment {
  id          String @id @default(uuid())
  name        Json // { ar: "عملاء VIP", en: "VIP Customers" }
  description Json?
  
  // Segmentation criteria
  criteria    Json // { minOrders: 10, minSpent: 1000, tags: ["premium"] }
  
  // Benefits
  benefits    Json // { discount: 10, freeShipping: true, earlyAccess: true }
  
  // Status
  isActive    Boolean @default(true)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  customers   Customer[]
  
  @@map("customer_segments")
}

model Customer {
  id          String @id @default(uuid())
  userId      String @unique
  segmentId   String?
  
  // Customer data
  firstName   String
  lastName    String
  email       String @unique
  phone       String?
  dateOfBirth DateTime?
  gender      String?
  
  // Address
  addresses   Address[]
  
  // Loyalty data
  loyaltyPoints    Int @default(0)
  totalSpent       Decimal @default(0) @db.Decimal(10, 2)
  totalOrders      Int @default(0)
  lastOrderDate    DateTime?
  
  // Preferences
  preferences Json // { newsletter: true, sms: false, language: "en" }
  tags        String[] // Custom tags for segmentation
  
  // Status
  isActive    Boolean @default(true)
  isVerified  Boolean @default(false)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  segment     CustomerSegment? @relation(fields: [segmentId], references: [id])
  orders      Order[]
  favorites   Favorite[]
  wishlists   Wishlist[]
  loyaltyTransactions LoyaltyTransaction[]
  loyaltyTier LoyaltyTier? @relation(fields: [loyaltyTierId], references: [id])
  loyaltyTierId String?
  targetedCampaigns TargetedCampaign[]
  store       Store? @relation(fields: [storeId], references: [id])
  storeId     String?
  
  @@map("customers")
}

model LoyaltyTier {
  id          String @id @default(uuid())
  name        Json // { ar: "برونزي", en: "Bronze" }
  description Json?
  
  // Tier requirements
  minPoints   Int
  minSpent    Decimal @db.Decimal(10, 2)
  minOrders   Int
  
  // Tier benefits
  benefits    Json // { discount: 5, freeShipping: false, pointsMultiplier: 1.0 }
  
  // Status
  isActive    Boolean @default(true)
  sortOrder   Int @default(0)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  customers   Customer[]
  
  @@map("loyalty_tiers")
}

model LoyaltyTransaction {
  id          String @id @default(uuid())
  customerId  String
  orderId     String?
  
  // Transaction details
  type        LoyaltyTransactionType
  points      Int // Positive for earned, negative for redeemed
  description Json // { ar: "نقاط مكافأة", en: "Reward Points" }
  
  // Status
  status      LoyaltyTransactionStatus @default(COMPLETED)
  expiresAt   DateTime?
  
  // Timestamps
  createdAt   DateTime @default(now())
  
  // Relationships
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  order       Order? @relation(fields: [orderId], references: [id])
  
  @@map("loyalty_transactions")
}

enum LoyaltyTransactionType {
  EARNED
  REDEEMED
  EXPIRED
  ADJUSTED
  BONUS
}

enum LoyaltyTransactionStatus {
  PENDING
  COMPLETED
  CANCELLED
  EXPIRED
}

// ============================================================================
// WISHLIST & TARGETED OFFERS
// ============================================================================

model Wishlist {
  id          String @id @default(uuid())
  customerId  String
  name        String? // Custom wishlist name
  isPublic    Boolean @default(false)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  items       WishlistItem[]
  
  @@map("wishlists")
}

model WishlistItem {
  id          String @id @default(uuid())
  wishlistId  String
  productId   String
  variantId   String?
  quantity    Int @default(1)
  notes       String?
  
  // Timestamps
  createdAt   DateTime @default(now())
  
  // Relationships
  wishlist    Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
  product     Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant     ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
  
  @@unique([wishlistId, productId, variantId])
  @@map("wishlist_items")
}

model TargetedOffer {
  id          String @id @default(uuid())
  name        Json // { ar: "عرض خاص", en: "Special Offer" }
  description Json?
  
  // Targeting criteria
  targetSegments String[] // Customer segment IDs
  targetTags     String[] // Customer tags
  targetProducts String[] // Product IDs
  
  // Offer details
  offerType   TargetedOfferType
  offerValue  Decimal @db.Decimal(10, 2)
  minOrderValue Decimal? @db.Decimal(10, 2)
  
  // Timing
  startDate   DateTime
  endDate     DateTime?
  
  // Status
  isActive    Boolean @default(true)
  isSent      Boolean @default(false)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  campaigns   TargetedCampaign[]
  
  @@map("targeted_offers")
}

model TargetedCampaign {
  id          String @id @default(uuid())
  offerId     String
  customerId  String
  
  // Campaign details
  status      CampaignStatus @default(PENDING)
  sentAt      DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  convertedAt DateTime?
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  offer       TargetedOffer @relation(fields: [offerId], references: [id], onDelete: Cascade)
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  @@unique([offerId, customerId])
  @@map("targeted_campaigns")
}

enum TargetedOfferType {
  DISCOUNT_PERCENTAGE
  DISCOUNT_FIXED
  FREE_SHIPPING
  FREE_PRODUCT
  LOYALTY_BONUS
}

enum CampaignStatus {
  PENDING
  SENT
  OPENED
  CLICKED
  CONVERTED
  EXPIRED
}

// ============================================================================
// SETTINGS & CONFIGURATION
// ============================================================================

model StoreSettings {
  id          String @id @default(uuid())
  
  // Store Information
  storeName   Json // { ar: "متجر سوليفا", en: "Soleva Store" }
  storeDescription Json?
  storeLogo   String?
  storeFavicon String?
  
  // Contact Information
  email       String
  phone       String
  address     Json // { ar: "العنوان", en: "Address" }
  
  // Business Information
  taxNumber   String?
  businessLicense String?
  currency    String @default("EGP")
  timezone    String @default("Africa/Cairo")
  language    String @default("en")
  
  // Social Media
  socialMedia Json // { facebook: "", instagram: "", twitter: "" }
  
  // SEO Settings
  metaTitle   Json?
  metaDescription Json?
  metaKeywords Json?
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("store_settings")
}

model IntegrationSettings {
  id          String @id @default(uuid())
  
  // Payment Gateways
  paymentGateways Json // { paymob: { enabled: true, apiKey: "" }, fawry: { enabled: false } }
  
  // Shipping Providers
  shippingProviders Json // { aramex: { enabled: true, apiKey: "" } }
  
  // Email Service
  emailService Json // { provider: "sendgrid", apiKey: "", fromEmail: "" }
  
  // SMS Service
  smsService Json // { provider: "twilio", apiKey: "", fromNumber: "" }
  
  // Analytics
  analytics Json // { googleAnalytics: "", facebookPixel: "" }
  
  // Social Login
  socialLogin Json // { google: { enabled: true, clientId: "" }, facebook: { enabled: false } }
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("integration_settings")
}

model SecuritySettings {
  id          String @id @default(uuid())
  
  // Password Policy
  passwordPolicy Json // { minLength: 8, requireUppercase: true, requireNumbers: true }
  
  // Session Settings
  sessionTimeout Int @default(3600) // seconds
  maxLoginAttempts Int @default(5)
  lockoutDuration Int @default(900) // seconds
  
  // 2FA Settings
  twoFactorRequired Boolean @default(false)
  twoFactorMethods Json // { sms: true, email: true, authenticator: true }
  
  // API Security
  apiRateLimit Int @default(100) // requests per minute
  apiKeyExpiry Int @default(365) // days
  
  // Audit Settings
  auditLogRetention Int @default(90) // days
  logFailedAttempts Boolean @default(true)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("security_settings")
}

// ============================================================================
// ROLE-BASED ACCESS CONTROL (RBAC)
// ============================================================================


model Permission {
  id          String @id @default(uuid())
  name        String @unique
  resource    String // e.g., "products", "orders", "customers"
  action      String // e.g., "create", "read", "update", "delete"
  description String?
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([resource, action])
  @@map("permissions")
}

// ============================================================================
// AI CHAT & LIVE SUPPORT
// ============================================================================

model ChatBot {
  id          String @id @default(uuid())
  name        String
  description String?
  
  // AI Configuration
  model       String @default("gpt-3.5-turbo")
  systemPrompt String
  temperature Float @default(0.7)
  maxTokens   Int @default(1000)
  
  // Behavior Settings
  autoRespond Boolean @default(true)
  escalationRules Json // Rules for when to escalate to human
  
  // Status
  isActive    Boolean @default(true)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  conversations Conversation[]
  
  @@map("chatbots")
}

model ChatTemplate {
  id          String @id @default(uuid())
  name        String
  category    String // "greeting", "product_inquiry", "order_support", etc.
  
  // Template Content
  content     Json // { ar: "مرحبا", en: "Hello" }
  variables   Json // Available variables for personalization
  
  // Status
  isActive    Boolean @default(true)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("chat_templates")
}

model EscalationRule {
  id          String @id @default(uuid())
  name        String
  description String?
  
  // Rule Conditions
  conditions  Json // { keywords: ["refund", "complaint"], sentiment: "negative" }
  
  // Escalation Actions
  actions     Json // { notifyAdmins: true, assignTo: "support_team" }
  
  // Priority
  priority    Int @default(1)
  
  // Status
  isActive    Boolean @default(true)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("escalation_rules")
}

// ============================================================================
// MULTI-STORE MANAGEMENT
// ============================================================================

model Store {
  id          String @id @default(uuid())
  name        Json // { ar: "متجر القاهرة", en: "Cairo Store" }
  description Json?
  
  // Store Information
  domain      String @unique
  subdomain   String @unique
  logo        String?
  favicon     String?
  
  // Contact Information
  email       String
  phone       String
  address     Json // { ar: "العنوان", en: "Address" }
  
  // Business Information
  taxNumber   String?
  businessLicense String?
  currency    String @default("EGP")
  timezone    String @default("Africa/Cairo")
  language    String @default("en")
  
  // Store Settings
  settings    Json // Store-specific settings
  theme       Json // Store theme configuration
  
  // Status
  isActive    Boolean @default(true)
  isDefault   Boolean @default(false)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  products    StoreProduct[]
  categories  StoreCategory[]
  orders      Order[]
  customers   Customer[]
  inventory   StoreInventory[]
  promotions  StorePromotion[]
  
  @@map("stores")
}

model StoreProduct {
  id          String @id @default(uuid())
  storeId     String
  productId   String
  
  // Store-specific pricing
  price       Decimal @db.Decimal(10, 2)
  comparePrice Decimal? @db.Decimal(10, 2)
  costPrice   Decimal? @db.Decimal(10, 2)
  
  // Store-specific inventory
  stockQuantity Int @default(0)
  lowStockThreshold Int @default(5)
  
  // Store-specific settings
  isActive    Boolean @default(true)
  isFeatured  Boolean @default(false)
  sortOrder   Int @default(0)
  
  // Store-specific SEO
  metaTitle   Json?
  metaDescription Json?
  metaKeywords Json?
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  store       Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  product     Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@unique([storeId, productId])
  @@map("store_products")
}

model StoreCategory {
  id          String @id @default(uuid())
  storeId     String
  categoryId  String
  
  // Store-specific settings
  isActive    Boolean @default(true)
  isFeatured  Boolean @default(false)
  sortOrder   Int @default(0)
  
  // Store-specific SEO
  metaTitle   Json?
  metaDescription Json?
  metaKeywords Json?
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  store       Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  @@unique([storeId, categoryId])
  @@map("store_categories")
}

model StoreInventory {
  id          String @id @default(uuid())
  storeId     String
  productId   String
  variantId   String?
  
  // Inventory tracking
  stockQuantity Int @default(0)
  reservedQuantity Int @default(0)
  availableQuantity Int @default(0)
  lowStockThreshold Int @default(5)
  
  // Location tracking
  warehouse   String?
  shelf       String?
  bin         String?
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  store       Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  product     Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant     ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
  
  @@unique([storeId, productId, variantId])
  @@map("store_inventory")
}

model StorePromotion {
  id          String @id @default(uuid())
  storeId     String
  
  // Promotion details
  name        Json // { ar: "عرض خاص", en: "Special Offer" }
  description Json?
  type        StorePromotionType
  value       Decimal @db.Decimal(10, 2)
  
  // Targeting
  targetProducts String[] // Product IDs
  targetCategories String[] // Category IDs
  targetCustomers String[] // Customer IDs
  
  // Conditions
  minOrderValue Decimal? @db.Decimal(10, 2)
  maxUsage      Int?
  usageCount    Int @default(0)
  
  // Timing
  startDate   DateTime
  endDate     DateTime?
  
  // Status
  isActive    Boolean @default(true)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  store       Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  @@map("store_promotions")
}

enum StorePromotionType {
  DISCOUNT_PERCENTAGE
  DISCOUNT_FIXED
  FREE_SHIPPING
  BUY_X_GET_Y
  FREE_PRODUCT
}

// ============================================================================
// REAL-TIME INFRASTRUCTURE
// ============================================================================

model RealtimeEvent {
  id          String @id @default(uuid())
  
  // Event details
  type        String // 'order_created', 'inventory_updated', 'customer_registered'
  entityType  String // 'Order', 'Product', 'Customer'
  entityId    String
  
  // Event data
  data        Json // Event payload
  metadata    Json? // Additional metadata
  
  // Targeting
  targetUsers String[] // User IDs to notify
  targetStores String[] // Store IDs
  
  // Status
  isProcessed Boolean @default(false)
  processedAt DateTime?
  
  // Timestamps
  createdAt   DateTime @default(now())
  
  @@map("realtime_events")
}

model WebSocketConnection {
  id          String @id @default(uuid())
  userId      String
  storeId     String?
  
  // Connection details
  socketId    String @unique
  userAgent   String?
  ipAddress   String?
  
  // Status
  isActive    Boolean @default(true)
  lastPing    DateTime @default(now())
  
  // Timestamps
  connectedAt DateTime @default(now())
  disconnectedAt DateTime?
  
  // Relationships
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("websocket_connections")
}

// ============================================================================
// PERFORMANCE INDEXES
// ============================================================================

// Note: Indexes are defined within their respective models above
// This section serves as documentation for the index strategy used
